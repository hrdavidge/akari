pro dewarp, image_array, edited_image_array

;Purpose:
;   NOTE it would be good if the point sources in the image were found with connected_pixels
;   so image could be aligned with the 2mass catalogue BEFORE dewarping
;   NOTE will need to check that filter ne 1
;
;Calling Sequence:
;
;Inputs:
;   array_image - array of structures, each containing information about an image
;Outputs:
;   edited_image_array - array of structures after it's been through dewarp step
;Keywords:
;
;Author & History:
;   Helen Davidge, Feb 2014, OU

;reading in number of structures
numberofstruc = size(image_array, /n_elements)
;reading in number of strings in header
sizeofheader = size(image_array[0].header, /n_elements)
;size of new header
newsize = sizeofheader + 1
;reading in x & y dimensions of images
array = size(image_array[0].image)
xsize = array(1)
ysize = array(2)

;reading in filter
long_filter = fxpar(image_array[0].header, 'FILTER')
;removing zeros in the strings
filter = strcompress(long_filter, /remove_all)
;reading in detector
long_detector = fxpar(image_array[0].header, 'DETECTOR')
;removing zeros in the strings
detector = strcompress(long_detector, /remove_all)
long_filter = fxpar(image_array[0].header, 'FILTER')
filter = strcompress(long_filter, /remove_all)

;creating a new template structure for edited images
blank_image = {image:fltarr(xsize,ysize), $
header:strarr(newsize), $
mask_image:bytarr(xsize,ysize), $
mask_header:strarr(newsize), $
noise:fltarr(xsize,ysize), $
noise_header:strarr(newsize), $
history:''}
;creating an array with number of stuructures as there are fits
new_image_array = replicate(blank_image, numberofstruc)

;use the code below to have different order polynomials
;create the x and y coefficents.
if(filter eq 'L15') then begin
  x_coeff = dblarr(4, 4)
  y_coeff = dblarr(4, 4)  
endif else begin
;  print, 'wrong filter'
  x_coeff = dblarr(3, 3)
  y_coeff = dblarr(3, 3)
endelse


;  x_coeff = dblarr(3, 3)
;  y_coeff = dblarr(3, 3)

;setting the constants
if (filter eq 'N3') then begin
  
;ss's method
    x00 = -3.34736330164143858212355553405359387397766113281250000000000000000
    x10 = 0.00356311654190259946908825305911250325152650475502014160156250000
    x20 = 0.00000682055601732814350955007645649352809869014890864491462707520
    x01 = 1.01811798313953838501788595749530941247940063476562500000000000000
    x11 = 0.00001568678239793089247353097270831767673371359705924987792968750
    x21 = -0.00000000996129847112262174433054294411110651807916838151868432760
    x02 = -0.00001312054904109752346945145379253361284099810291081666946411133
    x12 = 0.00000006534611159890565738484483537459879265441031748196110129356
    x22 = -0.00000000015453436594345779308434998816764935347656262365489965305
    y00 = 5.54990109492362204690607541124336421489715576171875000000000000000
    y10 = 0.98488350960882786733208149598794989287853240966796875000000000000
    y20 = 0.00001825054544378727371025522563385834473592694848775863647460938
    y01 = -0.01170424511955884226688251459336242987774312496185302734375000000
    y11 = -0.00001185899706938713105142113590773078612983226776123046875000000
    y21 = 0.00000004340193409077429677191429786657639322555723992991261184216
    y02 = 0.00001012345028108277300723204239485397692988044582307338714599609
    y12 = 0.00000000765737593585008324496172518128928041747371935343835502863
    y22 = -0.00000000006960699678588934962329014798166682866098486925920951762 

;03-12-14 dewarping numbers
;    x00 = 0.0
;    x10 = 0.00917503602064926107595432824837189400568604469299316406250000000
;    x20 = -0.00003868206064285177668386761506980064950766973197460174560546875
;    x01 = 0.99281264602772201222080639126943424344062805175781250000000000000
;    x11 = -0.00014671422666569838215260002112216852765413932502269744873046875
;    x21 = 0.00000032457618552835140247710328000041446472323514171876013278961
;    x02 = -0.00001381861507487129660264914277068015735494554974138736724853516
;    x12 = 0.00000023741731045989714809050119981997939433426836330909281969070
;    x22 = -0.00000000056036027228384627072643528133640868083009678457528934814
;    y00 = 0.0
;    y10 = 1.00522048391402396561034038313664495944976806640625000000000000000
;    y20 = 0.00000399518249998382329299427898061658481765334727242588996887207
;    y01 = 0.00013246435485204582980893472932137910902383737266063690185546875
;    y11 = -0.00002330000000000000053381778164496296312790946103632450103759766
;    y21 = -0.00000031730113188320960756756521081722866028940188698470592498779
;    y02 = 0.00001793850846921740411609585974517244721937458962202072143554688
;    y12 = -0.00000029628628558809601932426771621342798113118988112546503543854
;    y22 = 0.00000000072393530939838903651027736757214182949926595256329164840
  
;02-12-14 dewarping numbers
;    x00 = 0.0
;    x10 = 0.00224356105178228140695217973643593722954392433166503906250000000
;    x20 = -0.00002132351022489958444392464664840503019149764440953731536865234
;    x01 = 0.98740598423228687074981735349865630269050598144531250000000000000
;    x11 = -0.00007734420966735953430724881396685077561414800584316253662109375
;    x21 = 0.00000015890020123357874653445564756132357686624345660675317049026
;    x02 = 0.00000014005122199969077921210202589824556085318363329861313104630
;    x12 = 0.00000007370811010417704803566422023380910744094762776512652635574
;    x22 = -0.00000000017387670583595868159005393813643265688018146875037928112
;    y00 = 0.0
;    y10 = 1.00591223595647805133523888798663392663002014160156250000000000000
;    y20 = 0.00000186144860991815652266092011996034827348012186121195554733276
;    y01 = 0.00012768434294722257396625941794354730518534779548645019531250000
;    y11 = -0.00002330000000000000053381778164496296312790946103632450103759766
;    y21 = -0.00000030187954449537804825899698496494139021706359926611185073853
;    y02 = 0.00001677809678278781592409250877917514799264608882367610931396484
;    y12 = -0.00000027641367105393678210673935949359680819270579377189278602600
;    y22 = 0.00000000066792315335371670847494611155900114118910693150610313751
  
;01-12-14 dewarping numbers, does not work :/  
;    x00 = 0.0
;    x10 = 0.00217401436854165307915875970934393990319222211837768554687500000
;    x20 = -0.00002092404660836038159392631652355731830539298243820667266845703
;    x01 = 0.98655955477311141343932376912562176585197448730468750000000000000
;    x11 = -0.00007185713831484627066997772359968621458392590284347534179687500
;    x21 = 0.00000014366014185591815007213842628197575379545014584437012672424
;    x02 = 0.00000209674140776039009468451577988812317698830156587064266204834
;    x12 = 0.00000006355662724261949992380857105828129149927008256781846284866
;    x22 = -0.00000000014795012686616858033749444483704064620677165464712743415
;    y00 = 0.0
;    y10 = 1.00551451203651254218129906803369522094726562500000000000000000000
;    y20 = 0.00000307886710590515028091026725198808833283692365512251853942871
;    y01 = 0.00013141293366295114645493635752160344054573215544223785400390625
;    y11 = -0.00002330000000000000053381778164496296312790946103632450103759766
;    y21 = -0.00000031273859519018252627747811445146908226888626813888549804688
;    y02 = 0.00001721098144667491995846511643186715900810668244957923889160156
;    y12 = -0.00000029039097120861338558600595050052106671500951051712036132812
;    y22 = 0.00000000070772709921573579370450716571005166100061245515462360345

;old dewarping code - currently the 'best' numbers we have
;    x00 = -9.10501766204833984375000000000000000000000000000000000000000000000
;    x10 = 0.00313472747802734375000000000000000000000000000000000000000000000
;    x20 = 0.00000941487905947724357247352600097656250000000000000000000000000
;    x01 = 1.01901090145111083984375000000000000000000000000000000000000000000
;    x11 = 0.00002015639620367437601089477539062500000000000000000000000000000
;    x21 = -0.00000006462968116238698712550103664398193359375000000000000000000
;    x02 = -0.00001473794691264629364013671875000000000000000000000000000000000
;    x12 = 0.00000004570806666492899239528924226760864257812500000000000000000
;    x22 = 0.00000000000110208250945348362748177351022604852914810180664062500
;    y00 = 5.81239080429077148437500000000000000000000000000000000000000000000
;    y10 = 0.98957973718643188476562500000000000000000000000000000000000000000
;    y20 = 0.00000808277127362089231610298156738281250000000000000000000000000
;    y01 = -0.00960201956331729888916015625000000000000000000000000000000000000
;    y11 = -0.00002336982288397848606109619140625000000000000000000000000000000
;    y21 = 0.00000005900837152239546412602066993713378906250000000000000000000
;    y02 = 0.00000797479060565819963812828063964843750000000000000000000000000
;    y12 = -0.00000001019129669543872296344488859176635742187500000000000000000
;    y22 = 0.00000000000227582601201870016183193001779727637767791748046875000
endif else begin
  if(filter eq 'N4') then begin
    
;ss's method
    x00 = -4.00854210767290197736656409688293933868408203125000000000000000000
    x10 = 0.00472376478843302555210570403687597718089818954467773437500000000
    x20 = 0.00000254980348114351358949827147659661363832128699868917465209961
    x01 = 1.01622347123561418413828505435958504676818847656250000000000000000
    x11 = 0.00001648232363437409348882849158268726341702858917415142059326172
    x21 = 0.00000000152722445586025162318377520570501434948873509256372926757
    x02 = -0.00000647681994842612821422283761463312146133830538019537925720215
    x12 = 0.00000002319114740488672465853357471370771447638503559574019163847
    x22 = -0.00000000007702142096680496631983645570488608740611358172145628487
    y00 = 2.79053899057787901938354480080306529998779296875000000000000000000
    y10 = 0.98360701386954885183655505898059345781803131103515625000000000000
    y20 = 0.00002104056833904174454762461832224573754501761868596076965332031
    y01 = -0.01174978984392361508470870035125699359923601150512695312500000000
    y11 = -0.00001815974857509996818788651495868435858938028104603290557861328
    y21 = 0.00000005619370258357024216832936377996610133322974434122443199158
    y02 = 0.00001214121117255835160641651987445399640819232445210218429565430
    y12 = 0.00000002427405070731823971987244201089367612311775701527949422598
    y22 = -0.00000000012288442792089988792996134262680172841153414253767550690

;my old method
;    x00 = -4.50178050994873046875000000000000000000000000000000000000000000000
;    x10 = 0.00253992411307990550994873046875000000000000000000000000000000000
;    x20 = 0.00000468485995952505618333816528320312500000000000000000000000000
;    x01 = 1.01309227943420410156250000000000000000000000000000000000000000000
;    x11 = 0.00004005088339908979833126068115234375000000000000000000000000000
;    x21 = -0.00000003621182997903815703466534614562988281250000000000000000000
;    x02 = -0.00000130029798128816764801740646362304687500000000000000000000000
;    x12 = -0.00000001744274769066578301135450601577758789062500000000000000000
;    x22 = -0.00000000000108911068098099805823153474193532019853591918945312500
;    y00 = 4.24176788330078125000000000000000000000000000000000000000000000000
;    y10 = 0.98580217361450195312500000000000000000000000000000000000000000000
;    y20 = 0.00001683493064774665981531143188476562500000000000000000000000000
;    y01 = -0.01015454996377229690551757812500000000000000000000000000000000000
;    y11 = -0.00003481567546259611845016479492187500000000000000000000000000000
;    y21 = 0.00000009080214624646032461896538734436035156250000000000000000000
;    y02 = 0.00000935748539632186293601989746093750000000000000000000000000000
;    y12 = 0.00000005561539140330751251894980669021606445312500000000000000000
;    y22 = -0.00000000019009220586507780126339639537036418914794921875000000000
    endif else begin
  if(filter eq 'N2') then begin
    x00 = -5.83102037152904895123128881095908582210540771484375000000000000000
    x10 = 0.00190166780023176247918503811717982898699119687080383300781250000
    x20 = 0.00001111425776878996976744767150035997360646433662623167037963867
    x01 = 1.01852174886861890357181437138933688402175903320312500000000000000
    x11 = 0.00003721251214305678635917151719780804342008195817470550537109375
    x21 = -0.00000008093408498589416770452840965699436992508708499372005462646
    x02 = -0.00001055680265648051308904290662704639203184342477470636367797852
    x12 = 0.00000000945868283840541383393467767936452217369946993130724877119
    x22 = 0.00000000002177545358256679431188021281158399833355332475548493676
    y00 = 5.53136330106616203039493484538979828357696533203125000000000000000
    y10 = 0.98608794152619616557586823546444065868854522705078125000000000000
    y20 = 0.00001574161193898257016330483049060262601415161043405532836914062
    y01 = -0.01403844554408229493291937473031794070266187191009521484375000000
    y11 = -0.00001823530505017230431944082191808575998948072083294391632080078
    y21 = 0.00000009330311203500869994439644375394671271806146251037716865540
    y02 = 0.00001511991518337049007737141886886789166055677924305200576782227
    y12 = 0.00000002858274959643911468542086106326555183798632242542225867510
    y22 = -0.00000000021718985149424860994844304053029556897391749714643083280


;    x00 = -5.519641876220703125000000000000000000000000000000000000000000
;    x10 = -0.004233974963426589965820312500000000000000000000000000000000
;    x20 = 0.000017064083294826559722423553466796875000000000000000000000
;    x01 = 1.007941842079162597656250000000000000000000000000000000000000
;    x11 = 0.000148186503793112933635711669921875000000000000000000000000
;    x21 = -0.000000157829276759002823382616043090820312500000000000000000
;    x02 = 0.000015446334145963191986083984375000000000000000000000000000
;    x12 = -0.000000223111783270724117755889892578125000000000000000000000
;    x22 = 0.000000000044867134313397727396477421279996633529663085937500
;    y00 = 4.471411705017089843750000000000000000000000000000000000000000
;    y10 = 0.981100618839263916015625000000000000000000000000000000000000
;    y20 = 0.000029706910936511121690273284912109375000000000000000000000
;    y01 = -0.009216910228133201599121093750000000000000000000000000000000
;    y11 = 0.000038733811379643157124519348144531250000000000000000000000
;    y21 = 0.000000002317649183680714486399665474891662597656250000000000
;    y02 = -0.000009046329068951308727264404296875000000000000000000000000
;    y12 = 0.000000101819729536600789288058876991271972656250000000000000
;    y22 = -0.000000000573666336656231123924953863024711608886718750000000
endif else begin  
    if(filter eq 'S7') then begin
      x00 = -1.64395866602466811379201772069791331887245178222656250000000000000
      x10 = -0.00205535907780653257642677900207672792021185159683227539062500000
      x20 = 0.00005967058342279084868532701424470587880932725965976715087890625
      x01 = 0.98667272379199832954554949537850916385650634765625000000000000000
      x11 = 0.00042418724326333761111620934691757156542735174298286437988281250
      x21 = -0.00000127398503575181863899611327956007400530324957799166440963745
      x02 = 0.00007543092072902091312601446926322523722774349153041839599609375
      x12 = -0.00000123863549671431251886655894312028181047935504466295242309570
      x22 = 0.00000000371717940672399402945536612695356243341038293692690785974
      y00 = 1.18628962148974315127247791679110378026962280273437500000000000000
      y10 = 1.03011914113220504063406224304344505071640014648437500000000000000
      y20 = -0.00003415180367321219340225393890086991177668096497654914855957031
      y01 = -0.01501693472492364803128062078485527308657765388488769531250000000
      y11 = -0.00004636622197942578336689670170933652570965932682156562805175781
      y21 = 0.00000014047556206967618185903656953528173545464596827514469623566
      y02 = 0.00000631198706181244377695117864224272352657862938940525054931641
      y12 = -0.00000014883430273126461810169484951266172245709640264976769685745
      y22 = 0.00000000035743816402114579516577632830578916539598921531251107808      
      
;    x00 = -1.2122949361801147460937500000000000000000000000000000000
;    x10 = -0.0140161253511905670166015625000000000000000000000000000
;    x20 = 0.0000984982762020081281661987304687500000000000000000000
;    x01 = 0.9971933364868164062500000000000000000000000000000000000
;    x11 = 0.0004398331802804023027420043945312500000000000000000000
;    x21 = -0.0000011580895034057903103530406951904296875000000000000
;    x02 = 0.0000248035539698321372270584106445312500000000000000000
;    x12 = -0.0000009208236519953061360865831375122070312500000000000
;    x22 = 0.0000000018330795770182817250315565615892410278320312500
;    y00 = -2.4794640541076660156250000000000000000000000000000000000
;    y10 = 1.0745353698730468750000000000000000000000000000000000000
;    y20 = -0.0001778012519935145974159240722656250000000000000000000
;    y01 = -0.0033892453648149967193603515625000000000000000000000000
;    y11 = -0.0005035813665017485618591308593750000000000000000000000
;    y21 = 0.0000015325171034419327042996883392333984375000000000000
;    y02 = 0.0000003366050407294096658006310462951660156250000000000
;    y12 = 0.0000010069790050692972727119922637939453125000000000000
;    y22 = -0.0000000028353015490978350499062798917293548583984375000
endif else begin 
      if(filter eq 'S9W') then begin
        x00 = -6.02646906625118017331033115624450147151947021484375000000000000000
        x10 = 0.01155167383801701530554595365174463950097560882568359375000000000
        x20 = 0.00002305009780228260411641220961609377582135493867099285125732422
        x01 = 1.01563226154957031432957137440098449587821960449218750000000000000
        x11 = 0.00006932913177934229382801123442447988054482266306877136230468750
        x21 = -0.00000025613439077240828023517092010274964763993921224027872085571
        x02 = -0.00001202344432279332555040408242463811916422855574637651443481445
        x12 = -0.00000010350223070286531564502028419580414997369643970159813761711
        x22 = 0.00000000047639235810776077328521175627815999187308904083693050779
        y00 = 0.93021145417740658256633423661696724593639373779296875000000000000
        y10 = 1.02968820607089095453545724012656137347221374511718750000000000000
        y20 = -0.00002457308425998899059769162156463551127671962603926658630371094
        y01 = -0.01409240212058571022069042300017827074043452739715576171875000000
        y11 = -0.00003569190224057465856983412111347320205823052674531936645507812
        y21 = 0.00000003820029900355212923938519786921930165846106319804675877094
        y02 = -0.00000399290324566683530930046377993569706177368061617016792297363
        y12 = -0.00000009224763354032383779249320426840696995895996224135160446167
        y22 = 0.00000000048565027060004771060751216016295080113440718605488655157


;    x00 = 0.0439368374645709991455078125000000000000000000000000000
;    x10 = -0.0568445064127445220947265625000000000000000000000000000
;    x20 = 0.0002899656246881932020187377929687500000000000000000000
;    x01 = 0.9568574428558349609375000000000000000000000000000000000
;    x11 = 0.0014013481559231877326965332031250000000000000000000000
;    x21 = -0.0000052670079639938194304704666137695312500000000000000
;    x02 = 0.0002223196934210136532783508300781250000000000000000000
;    x12 = -0.0000052905711527273524552583694458007812500000000000000
;    x22 = 0.0000000194085369997765155858360230922698974609375000000
;    y00 = -1.5907883644104003906250000000000000000000000000000000000
;    y10 = 1.0706971883773803710937500000000000000000000000000000000
;    y20 = -0.0002209440281148999929428100585937500000000000000000000
;    y01 = 0.0058772126212716102600097656250000000000000000000000000
;    y11 = -0.0010893410071730613708496093750000000000000000000000000
;    y21 = 0.0000046978725549706723541021347045898437500000000000000
;    y02 = -0.0000809941484476439654827117919921875000000000000000000
;    y12 = 0.0000042988349377992562949657440185546875000000000000000
;    y22 = -0.0000000184978503625643497798591852188110351562500000000
endif else begin 
  if(filter eq 'S11') then begin
    ;ss method
;    x00 = -1.68881639395893312638463612529449164867401123046875000000000000000
;    x10 = -0.06347331643548764779083626308420207351446151733398437500000000000
;    x20 = 0.00028485569190717986189087529425023603835143148899078369140625000
;    x01 = 0.96426856924969317486073805412161163985729217529296875000000000000
;    x11 = 0.00122833141151872105023556969172204844653606414794921875000000000
;    x21 = -0.00000430618599970250211429355011172326328505732817575335502624512
;    x02 = 0.00014175377139058142569351395056997944266186095774173736572265625
;    x12 = -0.00000399749212940037467064156861962231914731091819703578948974609
;    x22 = 0.00000001409107914901612970838602908150993808789053218788467347622
;    y00 = -2.42489769050746861722700487007386982440948486328125000000000000000
;    y10 = 1.06871011681868344211920884845312684774398803710937500000000000000
;    y20 = -0.00022538574096568817742465562492526487403665669262409210205078125
;    y01 = 0.00764397321468818398415567827441918780095875263214111328125000000
;    y11 = -0.00109760784419099251089935176395329108345322310924530029296875000
;    y21 = 0.00000483367627887884889479382793942008333942794706672430038452148
;    y02 = -0.00010248352722947055913442493402243371747317723929882049560546875
;    y12 = 0.00000442100317710801500375658590336058750835945829749107360839844
;    y22 = -0.00000001905760693177052146294774882546302352537281876720953732729

;latest method
    x00 = -3.709345872899361129526596414507366716861724853515625000000000
    x10 = -0.026469483326271459749934322758235794026404619216918945312500
    x20 = 0.000167385375755972761694506667495829788094852119684219360352
    x01 = 0.993827578022764335230476717697456479072570800781250000000000
    x11 = 0.000635398644132317705693346887585448712343350052833557128906
    x21 = -0.000002341700319290926122031172573745294585023657418787479401
    x02 = 0.000064317874171709548520269039695307355941622518002986907959
    x12 = -0.000002193439188102553136098041286494719770416850224137306213
    x22 = 0.000000008035965870706772397025378982908516700689460776629858
    y00 = -2.991366427356436208384593555820174515247344970703125000000000
    y10 = 1.060012983592401258903237248887307941913604736328125000000000
    y20 = -0.000186310665940143385319038848990658152615651488304138183594
    y01 = 0.006534539958451720566279252722097226069308817386627197265625
    y11 = -0.000682723534942045184870096363738412037491798400878906250000
    y21 = 0.000003320438157694358048509361211464430141404591267928481102
    y02 = -0.000068282689332371844927009607584267314450698904693126678467
    y12 = 0.000002309020120117567297313371579847718351174989948049187660
    y22 = -0.000000011583882083919518071660018380866080667246365010214504

;    x00 = 0.0439368374645709991455078125000000000000000000000000000
;    x10 = -0.0568445064127445220947265625000000000000000000000000000
;    x20 = 0.0002899656246881932020187377929687500000000000000000000
;    x01 = 0.9568574428558349609375000000000000000000000000000000000
;    x11 = 0.0014013481559231877326965332031250000000000000000000000
;    x21 = -0.0000052670079639938194304704666137695312500000000000000
;    x02 = 0.0002223196934210136532783508300781250000000000000000000
;    x12 = -0.0000052905711527273524552583694458007812500000000000000
;    x22 = 0.0000000194085369997765155858360230922698974609375000000
;    y00 = -1.5907883644104003906250000000000000000000000000000000000
;    y10 = 1.0706971883773803710937500000000000000000000000000000000
;    y20 = -0.0002209440281148999929428100585937500000000000000000000
;    y01 = 0.0058772126212716102600097656250000000000000000000000000
;    y11 = -0.0010893410071730613708496093750000000000000000000000000
;    y21 = 0.0000046978725549706723541021347045898437500000000000000
;    y02 = -0.0000809941484476439654827117919921875000000000000000000
;    y12 = 0.0000042988349377992562949657440185546875000000000000000
;    y22 = -0.0000000184978503625643497798591852188110351562500000000
;old method
;    x00 = 4.2470378875732421875000000000000000000000000000000000000
;    x10 = -0.1167269572615623474121093750000000000000000000000000000
;    x20 = 0.0004772872780449688434600830078125000000000000000000000
;    x01 = 0.8316536545753479003906250000000000000000000000000000000
;    x11 = 0.0031306976452469825744628906250000000000000000000000000
;    x21 = -0.0000106116804090561345219612121582031250000000000000000
;    x02 = 0.0007488830597139894962310791015625000000000000000000000
;    x12 = -0.0000125197402667254209518432617187500000000000000000000
;    x22 = 0.0000000415826590938195295166224241256713867187500000000
;    y00 = -5.8609075546264648437500000000000000000000000000000000000
;    y10 = 1.1404253244400024414062500000000000000000000000000000000
;    y20 = -0.0004607774899341166019439697265625000000000000000000000
;    y01 = 0.0805814042687416076660156250000000000000000000000000000
;    y11 = -0.0024495210964232683181762695312500000000000000000000000
;    y21 = 0.0000096140020104940049350261688232421875000000000000000
;    y02 = -0.0003339058603160083293914794921875000000000000000000000
;    y12 = 0.0000090632547653513029217720031738281250000000000000000
;    y22 = -0.0000000359084211254412366542965173721313476562500000000
endif else begin
  if(filter eq 'L24') then begin
    x00 = 8.25351226946908234083366551203653216361999511718750000000000000000
    x10 = -0.00219767926603552750039471952447911462513729929924011230468750000
    x20 = 0.00000133736494533726088231257236871307725323276827111840248107910
    x01 = 0.93274185969375755789201321022119373083114624023437500000000000000
    x11 = -0.00006368806661238064108828543785634224150271620601415634155273438
    x21 = 0.00000037990435255467128485741957859278539189062939840368926525116
    x02 = -0.00007092132208042369967502388528046708415786270052194595336914062
    x12 = 0.00000026684427060028770068469657419929497166322107659652829170227
    x22 = -0.00000000141941698346709779459817113775451855040010684660956030712
    y00 = -0.17848543663847565854396748363797087222337722778320312500000000000
    y10 = 1.01187810547828505036704882513731718063354492187500000000000000000
    y20 = 0.00001612614605100282902426858666622422333603026345372200012207031
    y01 = -0.00356352222886099391507830347336494014598429203033447265625000000
    y11 = 0.00007907529900166962617824584214076821808703243732452392578125000
    y21 = -0.00000031247493695392273806970954465322964921369930380024015903473
    y02 = 0.00001350316012635158150064721566119274598349875304847955703735352
    y12 = -0.00000021976439068563708616027270546094962710981235431972891092300
    y22 = 0.00000000096515787444977739545305077796619880325934559550660196692
    
    
;    x00 = 2.0113930702209472656250000000000000000000000000000000000
;    x10 = 0.0293070226907730102539062500000000000000000000000000000
;    x20 = -0.0001320052688242867588996887207031250000000000000000000
;    x01 = 0.9281834363937377929687500000000000000000000000000000000
;    x11 = -0.0003054361732210963964462280273437500000000000000000000
;    x21 = 0.0000024736343675613170489668846130371093750000000000000
;    x02 =  0.0000722775075701065361499786376953125000000000000000000
;    x12 = -0.0000002186708485396593459881842136383056640625000000000
;    x22 = -0.0000000058745972530971357628004625439643859863281250000
;    y00 = 3.0272247791290283203125000000000000000000000000000000000
;    y10 = 0.9534506201744079589843750000000000000000000000000000000
;    y20 = 0.0002024488494498655200004577636718750000000000000000000
;    y01 = -0.0508366972208023071289062500000000000000000000000000000
;    y11 = 0.0008651845855638384819030761718750000000000000000000000
;    y21 = -0.0000028729516543535282835364341735839843750000000000000
;    y02 = 0.0001455317833460867404937744140625000000000000000000000
;    y12 = -0.0000028054103040631162002682685852050781250000000000000
;    y22 = 0.0000000093803791401114722248166799545288085937500000000
  endif else begin
  if(filter eq 'L18W') then begin
  ;28/07/15
;  x00 = 7.38493444429844547727270764880813658237457275390625000000000000000
;  x10 = 0.01244732148046166254895528169299723231233656406402587890625000000
;  x20 = -0.00004583279209323477739477029069270486161258304491639137268066406
;  x01 = 0.95066431136452689276694627551478333771228790283203125000000000000
;  x11 = -0.00022032527189434547359656035858677114447345957159996032714843750
;  x21 = 0.00000067627460202953770439726014634951312132216116879135370254517
;  x02 = -0.00012493289435183574267833328530485914598102681338787078857421875
;  x12 = 0.00000066099937992867397981608086968141613226634945021942257881165
;  x22 = -0.00000000171408248265639130030573776503977426188818355967669049278
;  y00 = -2.95725026366582044445863175496924668550491333007812500000000000000
;  y10 = 1.01400133878578557755645306315273046493530273437500000000000000000
;  y20 = -0.00000413842292454587270031764537070451126510306494310498237609863
;  y01 = 0.00098258753268090984200888726718403631821274757385253906250000000
;  y11 = -0.00004359175153057293148999018495004520445945672690868377685546875
;  y21 = 0.00000019771687985796259125757020486124915237269306089729070663452
;  y02 = -0.00000383476441799634293572341878220122168841044185683131217956543
;  y12 = 0.00000015022756884626567591067760210760129169216270383913069963455
;  y22 = -0.00000000044813468324004753262942428995100740268808792166055354755
  
  x00 = 7.38410383618086552104387010331265628337860107421875000000000000000
  x10 = 0.01246257400578912495625605316718065296299755573272705078125000000
  x20 = -0.00004588685267860754526600408631509253609692677855491638183593750
  x01 = 0.95068021714539330258020299879717640578746795654296875000000000000
  x11 = -0.00022059774108295108433624998056643562449607998132705688476562500
  x21 = 0.00000067721452666438015943907837226878321246203995542600750923157
  x02 = -0.00012498958374576165449194864454085518445936031639575958251953125
  x12 = 0.00000066194638636330470070784923533602217560201097512617707252502
  x22 = -0.00000000171730691942279530006295765680963613664111733214667765424
  y00 = -2.95746236881191171264049444289412349462509155273437500000000000000
  y10 = 1.01400061703698507464821432222379371523857116699218750000000000000
  y20 = -0.00000411891466783124554065440015016008601378416642546653747558594
  y01 = 0.00100915785929999173194115957841177078080363571643829345703125000
  y11 = -0.00004390450205702984572521743733553023503191070631146430969238281
  y21 = 0.00000019850912568905611230567231396959559930337491095997393131256
  y02 = -0.00000396453798989910891726684907809818980695126811042428016662598
  y12 = 0.00000015197527820558991649822376188150307996238552732393145561218
  y22 = -0.00000000045328676176671022377270600934022915656784746829544019420
    

;    x00 = 2.0113930702209472656250000000000000000000000000000000000
;    x10 = 0.0293070226907730102539062500000000000000000000000000000
;    x20 = -0.0001320052688242867588996887207031250000000000000000000
;    x01 = 0.9281834363937377929687500000000000000000000000000000000
;    x11 = -0.0003054361732210963964462280273437500000000000000000000
;    x21 = 0.0000024736343675613170489668846130371093750000000000000
;    x02 =  0.0000722775075701065361499786376953125000000000000000000
;    x12 = -0.0000002186708485396593459881842136383056640625000000000
;    x22 = -0.0000000058745972530971357628004625439643859863281250000
;    y00 = 3.0272247791290283203125000000000000000000000000000000000
;    y10 = 0.9534506201744079589843750000000000000000000000000000000
;    y20 = 0.0002024488494498655200004577636718750000000000000000000
;    y01 = -0.0508366972208023071289062500000000000000000000000000000
;    y11 = 0.0008651845855638384819030761718750000000000000000000000
;    y21 = -0.0000028729516543535282835364341735839843750000000000000
;    y02 = 0.0001455317833460867404937744140625000000000000000000000
;    y12 = -0.0000028054103040631162002682685852050781250000000000000
;    y22 = 0.0000000093803791401114722248166799545288085937500000000
    ;these numbers below are not for L18W or L24
;    x00 = 2.82797026634216308593750000000000000000000000000000
;    x10 = -0.08958362042903900146484375000000000000000000000000
;    x20 = 0.00038134018541313707828521728515625000000000000000
;    x01 = 0.86657965183258056640625000000000000000000000000000
;    x11 = 0.00252857105806469917297363281250000000000000000000
;    x21 = -0.00000855025700730038806796073913574218750000000000
;    x02 = 0.00060024694539606571197509765625000000000000000000
;    x12 = -0.00001002240060188341885805130004882812500000000000
;    x22 = 0.00000003321733998973286361433565616607666015625000
;    y00 = -5.28056049346923828125000000000000000000000000000000
;    y10 = 1.11968648433685302734375000000000000000000000000000
;    y20 = -0.00037315583904273808002471923828125000000000000000
;    y01 = 0.06911086291074752807617187500000000000000000000000
;    y11 = -0.00201094313524663448333740234375000000000000000000
;    y21 = 0.00000758958867663750424981117248535156250000000000
;    y02 = -0.00029127346351742744445800781250000000000000000000
;    y12 = 0.00000730481906430213712155818939208984375000000000
;    y22 = -0.00000002779992769319505896419286727905273437500000

endif else begin
  if(filter eq 'L15') then begin
;ss's method - 2nd order polynomial
;    x00 = 8.33989911598770206069275445770472288131713867187500000000000000000
;    x10 = 0.02977257560722386051099697112931607989594340324401855468750000000
;    x20 = -0.00014835519082846365212895178853358402193407528102397918701171875
;    x01 = 0.94492621925472708444004865668830461800098419189453125000000000000
;    x11 = -0.00038655817934910886857213796474752598442137241363525390625000000
;    x21 = 0.00000208644222827251201520144807677326070916024036705493927001953
;    x02 = -0.00004796443369664491867534680813456304804276442155241966247558594
;    x12 = 0.00000080311602526902972215832200025831255629782390315085649490356
;    x22 = -0.00000000528498200026684422631145270012227588285469437323627062142
;    y00 = -0.98345986106137550653016887736157514154911041259765625000000000000
;    y10 = 0.99922042650661235807518778528901748359203338623046875000000000000
;    y20 = 0.00004393290628141652271040559774029077289014821872115135192871094
;    y01 = -0.00371768308896814865874280719992839294718578457832336425781250000
;    y11 = 0.00000509476110830847485827022405602271248881152132526040077209473
;    y21 = 0.00000024158591912003335740703616543734177923852257663384079933167
;    y02 = -0.00001400995147028025699081216215446943351707886904478073120117188
;    y12 = 0.00000039633228050685171901573646685568164116375555749982595443726
;    y22 = -0.00000000239851435300491758518036069418657985075071792380185797811

;05/01/15
;    x00 = 6.121498181518581382931643020128831267356872558593750000000000
;    x10 = 0.043660506341537522190243691966315964236855506896972656250000
;    x20 = -0.000170004635339791621570851298805848728079581633210182189941
;    x01 = 0.992426000299374000412910845625447109341621398925781250000000
;    x11 = -0.000997454581635571569178666528898702381411567330360412597656
;    x21 = 0.000004032900995387398430220247946831335639217286370694637299
;    x02 = -0.000250793844933290836687195257681537441385444253683090209961
;    x12 = 0.000003807157431681311802464887789065883794137334916740655899
;    x22 = -0.000000015724747437635009646479672265964588895315046102041379
;    y00 = -1.522325412327974802906283002812415361404418945312500000000000
;    y10 = 1.013997558324016834419012411672156304121017456054687500000000
;    y20 = -0.000009633503545725453874322245784167506599260377697646617889
;    y01 = 0.002458224715383965346821026898282980255316942930221557617188
;    y11 = -0.000096999233576743230998522260488670099221053533256053924561
;    y21 = 0.000000598307759421124808987715697206066778335298295132815838
;    y02 = -0.000026772456043841650691816544394008303697773953899741172791
;    y12 = 0.000000569389419581583781987323567702619087071980175096541643
;    y22 = -0.000000002934202430785307416406143440597634186595144001330482
    
;06/01/15
;    x00 = 6.019915464274007810274724761256948113441467285156250000000000
;    x10 = 0.044027084701489332951851451980473939329385757446289062500000
;    x20 = -0.000209273655157210167459397309741575554653536528348922729492
;    x01 = 0.979750168958215539305456331931054592132568359375000000000000
;    x11 = -0.000868045850580602710785949049920873221708461642265319824219
;    x21 = 0.000004141743484012285644283064833803820192770217545330524445
;    x02 = -0.000189594863262215090112666748822789486439432948827743530273
;    x12 = 0.000002903064948101022343067553407869318959910742705687880516
;    x22 = -0.000000014183665577862979971287783135646537457930094205948990
;    y00 = -1.550702729537164481499189605528954416513442993164062500000000
;    y10 = 1.014115789246167853576707784668542444705963134765625000000000
;    y20 = -0.000007016108042370523335037185708173979037383105605840682983
;    y01 = 0.003635362459359811962422703857100714230909943580627441406250
;    y11 = -0.000112469960293547924039779528637694738790742121636867523193
;    y21 = 0.000000607211682442549524826044902298116667793692613486200571
;    y02 = -0.000031408204035625032985237781169018944638082757592201232910
;    y12 = 0.000000641901556680088765624342568572036071827824343927204609
;    y22 = -0.000000003068369950381847878875994653177262938559266558513627

;06/01/15 3rd order polynomial
;    x00 = 9.809229595127417766775579366367310285568237304687500000000000
;    x10 = -0.062477897544183570721632037248127744533121585845947265625000
;    x20 = 0.001024502774204279730019262473206254071556031703948974609375
;    x30 = -0.000003724075587780816687925216149079865601834171684458851814
;    x01 = 0.820831373570408917572649443172849714756011962890625000000000
;    x11 = 0.002595648063974972333950441694128130620811134576797485351562
;    x21 = -0.000035348507851529107845218319328139955359802115708589553833
;    x31 = 0.000000120143280683323874437920487576181294286925549386069179
;    x02 = 0.001142343852171509447149255755959984526271000504493713378906
;    x12 = -0.000021092656182299967566754275716256472605891758576035499573
;    x22 = 0.000000268152814594950667415903080084693677065388328628614545
;    x32 = -0.000000000883981390517779463927918089523024305909082443122315
;    x03 = -0.000003018089336538558180875278097454739167915249709039926529
;    x13 = 0.000000044360436117449384840647565219143300119242212531389669
;    x23 = -0.000000000562961996023820038037369400572233063551053078299446
;    x33 = 0.000000000001846935219878453757024182028070444694291957210552
;    y00 = -1.191723105691842921061152082984335720539093017578125000000000
;    y10 = 0.991004871748652149676672706846147775650024414062500000000000
;    y20 = 0.000261085900253252029684647439466971263755112886428833007812
;    y30 = -0.000000738527007651591561209663064357933137671352596953511238
;    y01 = -0.003055541624528072645883280955558802816085517406463623046875
;    y11 = 0.000177067849334849674279579456737110376707278192043304443359
;    y21 = -0.000003576396710940206465333948346319026256878714775666594505
;    y31 = 0.000000011085484314969524134443209020806087039545673178508878
;    y02 = 0.000085785154896358197266700851280063488957239314913749694824
;    y12 = -0.000003924598276008104170173122760001405140428687445819377899
;    y22 = 0.000000052070253159752531742131357586286788396989777538692579
;    y32 = -0.000000000139871056724211637993246525067181969953500342285224
;    y03 = -0.000000596509211423360919780494674574677915757092705462127924
;    y13 = 0.000000022975889419868264098780082354406273381641767628025264
;    y23 = -0.000000000245862936615751134583902885139363760080843945843299
;    y33 = 0.000000000000620989692775574157486462840548254989245929857944

;ss's method - 3rd order polynomial
;    x00 = 19.177526162036421908396732760593295097351074218750000000000000
;    x10 = -0.312011655701389778450050016544992104172706604003906250000000
;    x20 = 0.003564492236573577835928583468216856999788433313369750976562
;    x30 = -0.000010751341336303112331397417722467224621141212992370128632
;    x01 = 0.534916672728797393254751568747451528906822204589843750000000
;    x11 = 0.010606385512277244353995797609968576580286026000976562500000
;    x21 = -0.000114135807978285721891661963489639219915261492133140563965
;    x31 = 0.000000333762198729059546412946141852318149290113069582730532
;    x02 = 0.003503075571372345729803665648205424076877534389495849609375
;    x12 = -0.000086300770162280030406605491055671564026852138340473175049
;    x22 = 0.000000909037270566958104328712103603393757111916784197092056
;    x32 = -0.000000002618233129552370849310860749059419461115538751982967
;    x03 = -0.000008472998899445394009859872097578659122518729418516159058
;    x13 = 0.000000195163572972677522251755844601150968742331315297633410
;    x23 = -0.000000002061305509325343886948674813723580978575000699493103
;    x33 = 0.000000000005920033894020839647397655532733284499020964819493
;    y00 = -1.848222479042163302054291307285893708467483520507812500000000
;    y10 = 1.021262336529068059931546486041042953729629516601562500000000
;    y20 = -0.000105692327462001461261913159983549803655478172004222869873
;    y30 = 0.000000291927661870485840050240241086432213535317714558914304
;    y01 = 0.036978221915319679780065342811212758533656597137451171875000
;    y11 = -0.001311017543936954547409423632586822350276634097099304199219
;    y21 = 0.000010024758372520532569475114337276266951448633335530757904
;    y31 = -0.000000021315258708939444142251311200414454205542824638541788
;    y02 = -0.000343422452270373244637841070314721036993432790040969848633
;    y12 = 0.000010906032758104239994371292832298081521003041416406631470
;    y22 = -0.000000076177677744637703694191924186362996351817855611443520
;    y32 = 0.000000000152722392367248883920283801690664145928044703737214
;    y03 = 0.000000614900116125774153144200196569046923400492232758551836
;    y13 = -0.000000018867581372933151022438770733416490976708246307680383
;    y23 = 0.000000000114266711165253423518876224594957493468916354117937
;    y33 = -0.000000000000200000795203658460944841047205413660107012341349

;original method    
;    x00 = 1.9941391944885253906250000000000000000000000000000000000
;    x10 = 0.0430689752101898193359375000000000000000000000000000000
;    x20 = -0.0001911112049128860235214233398437500000000000000000000
;    x01 = 0.9295096993446350097656250000000000000000000000000000000
;    x11 = -0.0003490250674076378345489501953125000000000000000000000
;    x21 = 0.0000026001193873526062816381454467773437500000000000000
;    x02 = 0.0000630844879196956753730773925781250000000000000000000
;    x12 = -0.0000002520212092349538579583168029785156250000000000000
 ;   x22 = -0.0000000053931654697692010813625529408454895019531250000
 ;   y00 = 2.4759299755096435546875000000000000000000000000000000000
;    y10 = 0.9619577527046203613281250000000000000000000000000000000
;    y20 = 0.0001764251792337745428085327148437500000000000000000000
;    y01 = -0.0429230332374572753906250000000000000000000000000000000
;    y11 = 0.0008485961006954312324523925781250000000000000000000000
;    y21 = -0.0000028801457574445521458983421325683593750000000000000
;    y02 = 0.0001138863954111002385616302490234375000000000000000000
;    y12 = -0.0000027833827971335267648100852966308593750000000000000
;    y22 =  0.0000000095948253786559689615387469530105590820312500000
;improved original method
;    x00 = 3.235749721527099609375000000000000000000000000000000000000000
;    x10 = 0.035809110850095748901367187500000000000000000000000000000000
;    x20 = -0.000179611597559414803981781005859375000000000000000000000000
;    x01 = 0.908863723278045654296875000000000000000000000000000000000000
;    x11 = -0.000024979453883133828639984130859375000000000000000000000000
;    x21 = 0.000001337154571956489235162734985351562500000000000000000000
;    x02 = 0.000130975706269964575767517089843750000000000000000000000000
;    x12 = -0.000001562846364322467707097530364990234375000000000000000000
;    x22 = 0.000000000039202249085823481777879351284354925155639648437500
;    y00 = 0.863561332225799560546875000000000000000000000000000000000000
;    y10 = 0.983987152576446533203125000000000000000000000000000000000000
;    y20 = 0.000107812113128602504730224609375000000000000000000000000000
;    y01 = -0.021985964849591255187988281250000000000000000000000000000000
;    y11 = 0.000485015450976788997650146484375000000000000000000000000000
;    y21 = -0.000001776015778887085616588592529296875000000000000000000000
;    y02 = 0.000049491867684992030262947082519531250000000000000000000000
;    y12 = -0.000001549242597320699132978916168212890625000000000000000000
;    y22 = 0.000000005861693352926522493362426757812500000000000000000000

;13/01/15 more galaxy pairs, 2nd order - this works ok
;    x00 = 8.063491680107455650272640923503786325454711914062500000000000
;    x10 = 0.007987488194098921884256370162802340928465127944946289062500
;    x20 = -0.000028485832198631914728703673489462744328193366527557373047
;    x01 = 0.948908195861552727912169302726397290825843811035156250000000
;    x11 = -0.000124533980680264203975624037745717487268848344683647155762
;    x21 = 0.000000418483800971056721869264496613260995161454047774896026
;    x02 = -0.000100853789500532066642293771430161086755106225609779357910
;    x12 = -0.000000206013701409005907520300988206018999449042894411832094
;    x22 = 0.000000000793317496072380949049002382971081115403677586073172
;    y00 = -2.091196996287146614434959701611660420894622802734375000000000
;    y10 = 1.007899191557435347732507580076344311237335205078125000000000
;    y20 = 0.000006838926512380848355277928457551794849678117316216230392
;    y01 = -0.011078951871062796621925095053029508562758564949035644531250
;    y11 = 0.000205468129909363911213965314672691420128103345632553100586
;    y21 = -0.000000563051283835270357559527748536609692564525175839662552
;    y02 = 0.000054334187092458447246572789124385849390819203108549118042
;    y12 = -0.000001238454299488799850004596206365370392177283065393567085
;    y22 =  0.000000003955384316505029000378030625516279084052939651883207
    
;30/01/15 3rd order, same txt file as above
    x00 = 9.590999336167117306217733130324631929397583007812500000000000
    x10 = -0.008062169372497103581043376152592827565968036651611328125000
    x20 = 0.000022526096311874637805614321472980066118907416239380836487
    x30 = -0.000000019248327523624448573118391435377017018026890582405031
    x01 = 0.855393950301743921649233470816398039460182189941406250000000
    x11 = 0.001371604101024854072826686390840222884435206651687622070312
    x21 = -0.000009192006129728683743655530402616449237029883079230785370
    x31 = 0.000000020414183893851891503875393301704888049385999693186022
    x02 = 0.000994144624124675526169458983360982529120519757270812988281
    x12 = -0.000020968860897461537269115608439484788050322094932198524475
    x22 = 0.000000151306858915593336481901260044680146421569588710553944
    x32 = -0.000000000346225052518856499587864942064094689322395481667627
    x03 = -0.000003264448277084474736976869163607162249718385282903909683
    x13 = 0.000000068048170274745892629304159365810633630644588265568018
    x23 = -0.000000000520950686711223684572547737176712034923298233479727
    x33 = 0.000000000001235639642484947987978753765489895632056702168278
    y00 = -2.447576075230409653471497222199104726314544677734375000000000
    y10 = 1.009796346493099239438606673502363264560699462890625000000000
    y20 = 0.000033107442263315725291053515100259119208203628659248352051
    y30 = -0.000000115969220724879376221303970122961102262593158229719847
    y01 = -0.006760623110135068059012297680965275503695011138916015625000
    y11 = 0.000461562167926869184025190362419266421056818217039108276367
    y21 = -0.000005172374052142700614337605252712748438170820008963346481
    y31 = 0.000000014492095000719435879584199731908572550409530776960310
    y02 = 0.000116132295313071988982801807654965386973344720900058746338
    y12 = -0.000008289439578782070591972744311171084063971647992730140686
    y22 = 0.000000094166046434668845958790826550927066662666220508981496
    y32 = -0.000000000262106411558413517164410060387774378809488950992090
    y03 = -0.000000509708123483841309805041867170283254040441534016281366
    y13 = 0.000000034011771110902940515170159337110522557168224011547863
    y23 = -0.000000000390750839239071011322940511317465886453881296347390
    y33 = 0.000000000001098470941203535594530225296047664903294899252373
  endif
endelse
endelse
endelse
endelse
endelse  
endelse
endelse
endelse

;use the code below to have different order polynomials
if(filter eq 'L15') then begin
  x_coeff[0, 0] = x00
  x_coeff[1, 0] = x10
  x_coeff[2, 0] = x20
  x_coeff[3, 0] = x30
  x_coeff[0, 1] = x01
  x_coeff[1, 1] = x11
  x_coeff[2, 1] = x21
  x_coeff[3, 1] = x31
  x_coeff[0, 2] = x02
  x_coeff[1, 2] = x12
  x_coeff[2, 2] = x22
  x_coeff[3, 2] = x32
  x_coeff[0, 3] = x03
  x_coeff[1, 3] = x13
  x_coeff[2, 3] = x23
  x_coeff[3, 3] = x33

  y_coeff[0, 0] = y00
  y_coeff[1, 0] = y10
  y_coeff[2, 0] = y20
  y_coeff[3, 0] = y30
  y_coeff[0, 1] = y01
  y_coeff[1, 1] = y11
  y_coeff[2, 1] = y21
  y_coeff[3, 1] = y31
  y_coeff[0, 2] = y02
  y_coeff[1, 2] = y12
  y_coeff[2, 2] = y22
  y_coeff[3, 2] = y32
  y_coeff[0, 3] = y03
  y_coeff[1, 3] = y13
  y_coeff[2, 3] = y23
  y_coeff[3, 3] = y33
endif else begin
;  print, 'wrong filter!'
x_coeff[0, 0] = x00
x_coeff[1, 0] = x10
x_coeff[2, 0] = x20
x_coeff[0, 1] = x01
x_coeff[1, 1] = x11
x_coeff[2, 1] = x21
x_coeff[0, 2] = x02
x_coeff[1, 2] = x12
x_coeff[2, 2] = x22

y_coeff[0, 0] = y00
y_coeff[1, 0] = y10
y_coeff[2, 0] = y20
y_coeff[0, 1] = y01
y_coeff[1, 1] = y11
y_coeff[2, 1] = y21
y_coeff[0, 2] = y02
y_coeff[1, 2] = y12
y_coeff[2, 2] = y22
endelse

;x_coeff[0, 0] = x00
;x_coeff[1, 0] = x10
;x_coeff[2, 0] = x20
;x_coeff[0, 1] = x01
;x_coeff[1, 1] = x11
;x_coeff[2, 1] = x21
;x_coeff[0, 2] = x02
;x_coeff[1, 2] = x12
;x_coeff[2, 2] = x22

;y_coeff[0, 0] = y00
;y_coeff[1, 0] = y10
;y_coeff[2, 0] = y20
;y_coeff[0, 1] = y01
;y_coeff[1, 1] = y11
;y_coeff[2, 1] = y21
;y_coeff[0, 2] = y02
;y_coeff[1, 2] = y12
;y_coeff[2, 2] = y22

;going through each structure one at a time
for i = 0, (numberofstruc - 1) do begin
  ;reading in all of the info in the structure
  original_image = image_array[i].image
  original_header = image_array[i].header
  original_mask = image_array[i].mask_image
  original_mask_header = image_array[i].mask_header
  original_noise = image_array[i].noise
  original_noise_header = image_array[i].noise_header
  original_history = image_array[i].history

  ;reading in name of file
  name = fxpar(original_header, 'NAME')
    
  ;NOTE it would be good if the point sources in the image were found with connected_pixels
  ;so image could be aligned with the 2mass catalogue BEFORE dewarping
  
  ;dewarping the image
  if(detector eq 'NIR') then begin
  new_image = poly_2d(original_image, x_coeff, y_coeff, missing = 0)
  new_noise = poly_2d(original_noise, x_coeff, y_coeff, missing = 0)
  endif else begin
    new_image = poly_2d(original_image, x_coeff, y_coeff)
    new_noise = poly_2d(original_noise, x_coeff, y_coeff)
  endelse

  ;Editing the headers
  sxaddpar, original_header, "DEWARP", "DONE"
  sxaddpar, original_mask_header, "DEWARP", "DONE"
  sxaddpar, original_noise_header, "DEWARP", "DONE"

  ;message to say step has been done on specific image
  print, 'File ', name, " has been through dewarp step"
  ;load edited information into the new structure
  new_image_array[i].image = new_image
  new_image_array[i].header = original_header
  new_image_array[i].mask_image = original_mask
  new_image_array[i].mask_header = original_mask_header
  new_image_array[i].noise = new_noise
  new_image_array[i].noise_header = original_noise_header
  new_image_array[i].history = original_history
endfor

edited_image_array = new_image_array

end